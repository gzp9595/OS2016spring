# v9-cpu相关题目
---
请分析em.c，并补充cpu.md中描述不够或错误的地方。

###在v9-cpu中如何实现时钟中断的

时间中断需要用户自己设置，使用TIME指令进行设置。
当时间超过设定的时间阈值，发生时钟中断（有部分需要判断iena（中断使能）的信号，有地方不用判断），然后将trap（异常/错误编码）赋值成FTIMER（时间中断），iena清空，然后跳转到异常处理部分即可。

###v9-cpu指令，关键变量描述有误或不全的情况

* timer：计时器（和时间时间中断有关）
* cycle：一个指令周期
* detla：一次的指令周期时长
* xcycle：一个时钟周期
* timeout：时钟中断的阈值（由用户自己设置）
* usp：用户栈指针
* ssp：系统栈指针
*
###在v9-cpu中的跳转相关操作是如何实现的

* JMP/JMPI指令，把指令上的操作数加到xpc上；
* JSR/JSRA指令，先在栈中保存当前的pc值，再跳转；
* BRANCH指令，条件判断结果为真跳转，反之继续执行。

###在v9-cpu中如何设计相应指令，可有效实现函数调用与返回

函数调用时，将寄存器保存，将需要传入的变量压入到栈中。
在使用传入变量的时候，访问``sp-8`` ``sp-16``等即可。
在退出函数的时候，恢复寄存器的值，并将返回值放在a中即可。


###emhello/os0/os1等程序被加载到内存的哪个位置,其堆栈是如何设置的
程序被加载到内存起始位置，栈底为memsz - FS_SZ位置，即除去内存文件系统的内存最后的位置。

###在v9-cpu中如何完成一次内存地址的读写的

它设置的页大小是4096，访存操作是先截尾并查看页表tr中是否有虚页号的位置，如果有，返回物理页；没有则在``rlook/wlook函数``中查看。如果存在虚页映射（需要``paging使能``），那么首先根据访存地址的高10位，然后调用``setpage()函数``对``tr、tw``进行修改即可；反之cpu不区分虚拟与物理地址，直接映射，返回即可。

在观看程序的时候发现物理地址是真实的物理地址加上1，并且程序是使用的位运算代替的加法运算。

###在v9-cpu中如何实现分页机制

它设置的页大小是4096，其中虚拟地址最后十二位是页内的偏移，前十位对应一个Page Table；中间十位对应Page Table中的一项。每一项对应一个虚拟物理页映射，偏移量在物理虚拟页内是一致的。
